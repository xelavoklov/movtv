<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Лента канала — ленивые посты</title>
  <style>
    body{font-family:Helvetica,Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:800px;margin:0 auto}
    .post{background:#fff;border-radius:12px;padding:12px 14px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .meta{font-size:12px;color:#666;margin-bottom:8px}
    .bubble{white-space:pre-wrap;color:#111;font-size:15px;line-height:1.4}
    .forward{font-size:12px;color:#0b72e6;margin-bottom:6px}
    .media{margin-top:8px}
    .media img{max-width:100%;border-radius:8px}
    .loading{display:flex;align-items:center;justify-content:center;padding:20px;color:#444}
    #status{font-size:13px;color:#666;margin-bottom:10px}
    .sender{font-weight:600;color:#1a73e8;margin-right:8px}
    body {
  background-color: #7195ba; /* Классический фон Telegram */
  background-image: url('https://www.transparenttextures.com'); /* Легкий паттерн */
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 20px 0;
}

#feed {
  width: 100%;
  max-width: 600px; /* Ширина как в десктопном ТГ */
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.post {
  background: white;
  padding: 8px 12px;
  border-radius: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  position: relative;
  max-width: 90%;
  align-self: flex-start; /* В канале посты обычно прижаты к левому краю */
  margin: 0 10px;
}

/* Мета-данные (Имя отправителя и дата) */
.meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.sender {
  color: #3390ec; /* Тот самый синий цвет ТГ */
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
}

.meta span:last-child {
  color: #a8a8a8;
  font-size: 11px;
  margin-left: 10px;
}

/* Пересланные сообщения */
.forward {
  border-left: 2px solid #3390ec;
  padding-left: 8px;
  margin-bottom: 8px;
  color: #3390ec;
  font-size: 13px;
  font-style: italic;
}

/* Текст сообщения */
.bubble {
  font-size: 15px;
  line-height: 1.4;
  color: #222;
  word-wrap: break-word;
  white-space: pre-wrap; /* Чтобы сохранялись переносы строк */
}

/* Медиа-контент */
.media img {
  max-width: 100%;
  border-radius: 8px;
  margin-top: 8px;
  display: block;
}

.media a {
  display: block;
  margin-top: 8px;
  color: #3390ec;
  text-decoration: none;
  font-size: 14px;
}

/* Индикатор загрузки внизу */
#sentinel {
  text-align: center;
  padding: 20px;
  color: white;
  font-size: 14px;
}
  </style>
</head>
<body>
  <div class="container">
    <h2>Лента канала</h2>
    <div id="status">Загружено: <span id="count">0</span></div>
    <div id="feed"></div>
    <div id="sentinel" class="loading">Загрузка…</div>
  </div>

  <script>
    // Параметры
    const BATCH = 10;
    let posts = [];
    let index = 0;

    function escapeHtml(s){
      if(!s) return '';
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    function isImage(name){
      return /\.(jpg|jpeg|png|gif|webp)$/i.test(name);
    }

    function renderPost(p){
      const d = document.createElement('div');
      d.className = 'post';

      const meta = document.createElement('div');
      meta.className = 'meta';
      // --- Кружок-аватар и имя ---
      let personId = p.person_id || p.sender_id || p.from_id;
      const authorBlock = document.createElement('span');
      authorBlock.style.display = 'inline-flex';
      authorBlock.style.alignItems = 'center';
      if(personId){
        const avatar = document.createElement('img');
        avatar.src = `https://aye.monster/media/person/${personId}.jpg`;
        avatar.alt = p.person_name || '';
        avatar.style.width = '28px';
        avatar.style.height = '28px';
        avatar.style.borderRadius = '50%';
        avatar.style.objectFit = 'cover';
        avatar.style.marginRight = '6px';
        avatar.style.verticalAlign = 'middle';
        avatar.style.marginBottom = '0px'; // убираем большой отступ
        authorBlock.appendChild(avatar);
      }
      const sender = document.createElement('a');
      sender.className = 'sender';
      sender.href = p.link || '#';
      sender.textContent = p.person_name || p.sender_id || '';
      sender.target = '_blank';
      authorBlock.appendChild(sender);
      meta.appendChild(authorBlock);
      // ---
      const date = document.createElement('span'); date.textContent = p.date || '';
      meta.appendChild(date);
      d.appendChild(meta);

      if(p.forward){
        const f = document.createElement('div'); f.className='forward';
        // --- Кружок-аватар для forward ---
        let fwdPersonId = p.forward.person_id || p.forward.sender_id || p.forward.from_id;
        let fwdName = p.forward.person_name || p.forward.post_author || p.forward.from_id || '';
        let fwdLink = p.forward.link || '';
        // --- Внешний контейнер для строки ---
        const fwdLine = document.createElement('span');
        fwdLine.style.display = 'inline-flex';
        fwdLine.style.alignItems = 'center';
        fwdLine.style.marginLeft = '0';
        fwdLine.style.marginTop = '0';
        fwdLine.style.marginBottom = '0';
        fwdLine.style.padding = '0';
        fwdLine.appendChild(document.createTextNode('Forwarded from '));
        if(fwdPersonId){
          const avatarFwd = document.createElement('img');
          avatarFwd.src = `https://aye.monster/media/person/${fwdPersonId}.jpg`;
          avatarFwd.alt = fwdName;
          avatarFwd.style.width = '20px';
          avatarFwd.style.height = '20px';
          avatarFwd.style.borderRadius = '50%';
          avatarFwd.style.objectFit = 'cover';
          avatarFwd.style.marginRight = '6px';
          avatarFwd.style.verticalAlign = 'middle';
          fwdLine.appendChild(avatarFwd);
        }
        if(fwdLink && fwdName){
          const fwdA = document.createElement('a');
          fwdA.href = fwdLink;
          fwdA.textContent = fwdName;
          fwdA.target = '_blank';
          fwdA.style.fontWeight = 'bold';
          fwdA.style.color = '#3390ec';
          fwdLine.appendChild(fwdA);
        } else {
          const fwdSpan = document.createElement('span');
          fwdSpan.textContent = fwdName;
          fwdSpan.style.fontWeight = 'bold';
          fwdSpan.style.color = '#3390ec';
          fwdLine.appendChild(fwdSpan);
        }
        f.appendChild(fwdLine);
        d.appendChild(f);
      }

      const bubble = document.createElement('div'); bubble.className='bubble';
      bubble.innerHTML = escapeHtml(p.text || '');
      d.appendChild(bubble);

      if(p.media){
        const mediaWrap = document.createElement('div'); mediaWrap.className='media';
        // Используем real_filename для подстановки реального имени файла, если оно есть
        let fname = '';
        if (p.real_filename && typeof p.real_filename === 'string' && p.real_filename.trim()) {
          fname = p.real_filename.trim();
        } else {
          fname = p.media ? p.media.trim() : '';
        }
        let href;
        if(isImage(fname)){
          href = 'https://aye.monster/' + fname;
          const img = document.createElement('img'); img.src = href; img.alt = fname;
          mediaWrap.appendChild(img);
        } else if(/\.(mp4|webm|ogg)$/i.test(fname)){
          // Видео: добавляем media/videos/
          href = 'https://aye.monster/media/videos/' + fname;
          const video = document.createElement('video');
          video.src = href;
          video.controls = true;
          video.style.maxWidth = '100%';
          video.style.borderRadius = '8px';
          mediaWrap.appendChild(video);
        } else {
          href = 'https://aye.monster/' + fname;
          const a = document.createElement('a'); a.href = href; a.textContent = fname; a.target = '_blank';
          mediaWrap.appendChild(a);
        }
        d.appendChild(mediaWrap);
      }

      return d;
    }

    async function loadJson(){
      try{
        const resp = await fetch('channel.json');
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        posts = await resp.json();
      }catch(e){
        document.getElementById('sentinel').textContent = 'Не удалось загрузить channel.json: ' + e.message;
        console.error(e);
      }
    }

    function loadNext(){
      if(index >= posts.length) {
        document.getElementById('sentinel').textContent = 'Все посты загружены';
        return;
      }
      const feed = document.getElementById('feed');
      const to = Math.min(index + BATCH, posts.length);
      for(let i = index; i < to; i++){
        const el = renderPost(posts[i]);
        feed.appendChild(el);
      }
      index = to;
      document.getElementById('count').textContent = index;
      if(index >= posts.length){
        document.getElementById('sentinel').textContent = 'Все посты загружены';
      }
    }

    // IntersectionObserver для подгрузки
    let loading = false;
    const observer = new IntersectionObserver((entries)=>{
      entries.forEach(ent=>{
        if(ent.isIntersecting){
          if(loading) return;
          if(index >= posts.length) {
            const s = document.getElementById('sentinel');
            observer.unobserve(s);
            s.textContent = 'Все посты загружены';
            return;
          }
          loading = true;
          try{
            loadNext();
          }catch(e){
            console.error(e);
          }
          loading = false;
        }
      });
    },{root:null,rootMargin:'0px',threshold:0.1});

    (async function(){
      await loadJson();
      // загрузим первую пачку
      loadNext();
      // наблюдаем sentinel
      const s = document.getElementById('sentinel');
      observer.observe(s);
    })();
  </script>
</body>
</html>