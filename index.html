<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>ауе228.рф</title>
  <style>
    body{font-family:Helvetica,Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
    .container{max-width:800px;margin:0 auto}
    .post{background:#fff;border-radius:12px;padding:12px 14px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .meta{font-size:12px;color:#666;margin-bottom:8px}
    .bubble{white-space:pre-wrap;color:#111;font-size:15px;line-height:1.4}
    .forward{font-size:12px;color:#0b72e6;margin-bottom:6px}
    .media{margin-top:8px}
    .media img{max-width:100%;border-radius:8px}
    .loading{display:flex;align-items:center;justify-content:center;padding:20px;color:#444}
    #status{font-size:13px;color:#666;margin-bottom:10px}
    .sender{font-weight:600;color:#1a73e8;margin-right:8px}
    body {
  background-color: #7195ba; /* Классический фон Telegram */
  background-image: url('https://www.transparenttextures.com'); /* Легкий паттерн */
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  padding: 20px 0;
}

#feed {
  width: 100%;
  max-width: 600px; /* Ширина как в десктопном ТГ */
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.post {
  background: white;
  padding: 8px 12px;
  border-radius: 12px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  position: relative;
  max-width: 90%;
  align-self: flex-start; /* В канале посты обычно прижаты к левому краю */
  margin: 0 10px;
}

/* Мета-данные (Имя отправителя и дата) */
.meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.sender {
  color: #3390ec; /* Тот самый синий цвет ТГ */
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
}

.meta span:last-child {
  color: #a8a8a8;
  font-size: 11px;
  margin-left: 10px;
}

/* Пересланные сообщения */
.forward {
  border-left: 2px solid #3390ec;
  padding-left: 8px;
  margin-bottom: 8px;
  color: #3390ec;
  font-size: 13px;
  font-style: italic;
}

/* Текст сообщения */
.bubble {
  font-size: 15px;
  line-height: 1.4;
  color: #222;
  word-wrap: break-word;
  white-space: pre-wrap; /* Чтобы сохранялись переносы строк */
}

/* Медиа-контент */
.media img {
  max-width: 100%;
  border-radius: 8px;
  margin-top: 8px;
  display: block;
}

.media a {
  display: block;
  margin-top: 8px;
  color: #3390ec;
  text-decoration: none;
  font-size: 14px;
}

/* Индикатор загрузки внизу */
#sentinel {
  text-align: center;
  padding: 20px;
  color: white;
  font-size: 14px;
}
#sentinel.hidden {
  visibility: hidden;
  height: 40px;
}
#status { display: none; }
  </style>
  <!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106831120', 'ym');

    ym(106831120, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", referrer: document.referrer, url: location.href, accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/106831120" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
</head>
<body>
  <div class="container">
    <h2>ауе228.рф</h2>
    <div id="status">Загружено: <span id="count">0</span></div>
    <div id="feed"></div>
    <div id="sentinel" class="loading hidden">Загрузка…</div>
  </div>

  <script>
    // Параметры
    const BATCH = 10;
    let posts = [];
    let index = 0;

    function escapeHtml(s){
      if(!s) return '';
      // support arrays (some messages have text as array) and non-string values
      if(Array.isArray(s)){
        s = s.map(it => typeof it === 'string' ? it : (it && it.text) || '').join('');
      } else if (typeof s !== 'string') {
        s = String(s);
      }
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function isImage(name){
      return /\.(jpg|jpeg|png|gif|webp)$/i.test(name);
    }
    function isPlaceholder(name){
      if(!name) return true;
      if(typeof name !== 'string') return false;
      return name.trim().startsWith('(File not included');
    }

    function renderPost(p){
      const d = document.createElement('div');
      d.className = 'post';

      const meta = document.createElement('div');
      meta.className = 'meta';
      // --- Кружок-аватар и имя ---
      let personId = p.person_id || p.sender_id || p.from_id;
      const authorBlock = document.createElement('span');
      authorBlock.style.display = 'inline-flex';
      authorBlock.style.alignItems = 'center';
      if(personId){
        const avatar = document.createElement('img');
        avatar.src = `https://aye.monster/media/person/${personId}.jpg`;
        avatar.alt = p.person_name || '';
        avatar.style.width = '28px';
        avatar.style.height = '28px';
        avatar.style.borderRadius = '50%';
        avatar.style.objectFit = 'cover';
        avatar.style.marginRight = '6px';
        avatar.style.verticalAlign = 'middle';
        avatar.style.marginBottom = '0px'; // убираем большой отступ
        authorBlock.appendChild(avatar);
      }
      const sender = document.createElement('a');
      sender.className = 'sender';
      // display name from `from`, link constructed from `from_id` as requested
      const fromDisplay = p.from || p.person_name || p.sender || '';
      const fromId = p.from_id || p.sender_id || p.person_id || '';
      sender.textContent = fromDisplay;
      sender.target = '_blank';
      if(fromId) {
        sender.href = 'https://t.me/' + fromId;
      } else {
        sender.href = p.link || '#';
      }
      authorBlock.appendChild(sender);
      meta.appendChild(authorBlock);
      // ---
      const date = document.createElement('span'); date.textContent = p.date || '';
      meta.appendChild(date);
      d.appendChild(meta);

      // Поддержка пересылок: некоторые экспорты используют `forwarded_from` поля
      if(p.forward || p.forwarded_from || p.forwarded_from_id){
        const f = document.createElement('div'); f.className='forward';
        // --- Кружок-аватар для forward ---
        let fwdPersonId = (p.forward && (p.forward.person_id || p.forward.sender_id || p.forward.from_id)) || p.forwarded_from_id;
        let fwdName = (p.forward && (p.forward.person_name || p.forward.post_author || p.forward.from)) || p.forwarded_from || '';
        let fwdId = (p.forward && (p.forward.from_id || p.forward.sender_id)) || p.forwarded_from_id || '';
        const fwdLine = document.createElement('span');
        fwdLine.style.display = 'inline-flex';
        fwdLine.style.alignItems = 'center';
        fwdLine.style.marginLeft = '0';
        fwdLine.style.marginTop = '0';
        fwdLine.style.marginBottom = '0';
        fwdLine.style.padding = '0';
        fwdLine.appendChild(document.createTextNode('Forwarded from '));
        if(fwdPersonId){
          const avatarFwd = document.createElement('img');
          avatarFwd.src = `https://aye.monster/media/person/${fwdPersonId}.jpg`;
          avatarFwd.alt = fwdName;
          avatarFwd.style.width = '20px';
          avatarFwd.style.height = '20px';
          avatarFwd.style.borderRadius = '50%';
          avatarFwd.style.objectFit = 'cover';
          avatarFwd.style.marginRight = '6px';
          avatarFwd.style.verticalAlign = 'middle';
          fwdLine.appendChild(avatarFwd);
        }
        if(fwdId){
          const fwdA = document.createElement('a');
          fwdA.href = 'https://t.me/' + fwdId;
          fwdA.textContent = fwdName || fwdId;
          fwdA.target = '_blank';
          fwdA.style.fontWeight = 'bold';
          fwdA.style.color = '#3390ec';
          fwdLine.appendChild(fwdA);
        } else if((p.forward && p.forward.link) && fwdName){
          const fwdA = document.createElement('a');
          fwdA.href = p.forward.link;
          fwdA.textContent = fwdName;
          fwdA.target = '_blank';
          fwdA.style.fontWeight = 'bold';
          fwdA.style.color = '#3390ec';
          fwdLine.appendChild(fwdA);
        } else {
          const fwdSpan = document.createElement('span');
          fwdSpan.textContent = fwdName;
          fwdSpan.style.fontWeight = 'bold';
          fwdSpan.style.color = '#3390ec';
          fwdLine.appendChild(fwdSpan);
        }
        f.appendChild(fwdLine);
        d.appendChild(f);
      }

      const bubble = document.createElement('div'); bubble.className='bubble';
      bubble.innerHTML = escapeHtml(p.text || '');
      d.appendChild(bubble);

      if(p.media || (p.file_name && !isPlaceholder(p.file_name)) || (p.photo && !isPlaceholder(p.photo))){
        const mediaWrap = document.createElement('div'); mediaWrap.className='media';
        // Формируем список медиа по приоритету: file_name -> real_media_path -> media
        let mediaList = [];
        if (p && p.id === 2) console.log('DEBUG renderPost start id=2', p);
        if (Array.isArray(p.file_name)) {
          mediaList = p.file_name.filter(x=>!isPlaceholder(x));
        } else if (typeof p.file_name === 'string' && p.file_name.trim() && !isPlaceholder(p.file_name)) {
          mediaList = [p.file_name.trim()];
        } else if (p.photo && typeof p.photo === 'string' && /\.[a-z0-9]{2,6}$/i.test(p.photo)) {
          if(!isPlaceholder(p.photo)) mediaList = [p.photo.trim()];
        } else if (Array.isArray(p.real_media_path)) {
          mediaList = p.real_media_path.filter(x=>!isPlaceholder(x));
        } else if (typeof p.real_media_path === 'string' && p.real_media_path.trim()) {
          if(!isPlaceholder(p.real_media_path)) mediaList = [p.real_media_path.trim()];
        } else if (p.media) {
          if(!isPlaceholder(p.media)) mediaList = [p.media.trim()];
        }
        if (p && p.id === 2) console.log('DEBUG mediaList for id=2', mediaList);

        for (const fname of mediaList) {
          if(!fname) continue;
          // Поддержка значений вида "photos/xxx.jpg" — если путь содержит папку,
          // считаем его относительным к /media и кодируем только сегменты пути.
          let href;
          if (fname.includes('/')) {
            const parts = fname.split('/').filter(Boolean);
            const root = parts[0].toLowerCase();
            const allowed = ['photos','videos','audio','files','person'];
            const encoded = parts.map(p => encodeURIComponent(p)).join('/');
            if (allowed.includes(root)) {
              href = 'https://aye.monster/media/' + encoded;
            } else {
              // если неизвестный префикс — помещаем в files
              href = 'https://aye.monster/media/files/' + encoded;
            }
          } else {
            const enc = encodeURIComponent(fname);
            if(isImage(fname)){
              href = 'https://aye.monster/media/photos/' + enc;
            } else if(/\.(mp4|webm|ogg)$/i.test(fname)){
              href = 'https://aye.monster/media/videos/' + enc;
            } else if(/\.(mp3|wav|ogg|m4a|oga)$/i.test(fname)){
              href = 'https://aye.monster/media/audio/' + enc;
            } else {
              href = 'https://aye.monster/media/files/' + enc;
            }
          }

          // Вставляем соответствующий элемент
          if(isImage(fname) || href.toLowerCase().includes('/photos/')){
            const img = document.createElement('img'); img.src = href; img.alt = fname;
            mediaWrap.appendChild(img);
          } else if(/\.(mp4|webm|ogg)$/i.test(fname) || href.toLowerCase().includes('/videos/')){
            const video = document.createElement('video');
            video.src = href;
            video.controls = true;
            video.style.maxWidth = '100%';
            video.style.borderRadius = '8px';
            mediaWrap.appendChild(video);
          } else if(/\.(mp3|wav|ogg|m4a|oga)$/i.test(fname) || href.toLowerCase().includes('/audio/')){
            // Контейнер для аудио и названия файла
            const audioContainer = document.createElement('div');
            audioContainer.style.display = 'flex';
            audioContainer.style.alignItems = 'center';
            audioContainer.style.marginTop = '8px';

            const audio = document.createElement('audio');
            audio.src = href;
            audio.controls = true;
            audio.style.display = 'block';
            audio.style.marginRight = '12px';

            const fnameSpan = document.createElement('span');
            fnameSpan.textContent = fname;
            fnameSpan.style.fontSize = '13px';
            fnameSpan.style.color = '#555';
            fnameSpan.style.wordBreak = 'break-all';

            audioContainer.appendChild(audio);
            audioContainer.appendChild(fnameSpan);
            mediaWrap.appendChild(audioContainer);
          } else {
            const a = document.createElement('a'); a.href = href; a.textContent = fname; a.target = '_blank';
            mediaWrap.appendChild(a);
          }
        }
        d.appendChild(mediaWrap);
      }

      return d;
    }

    async function loadJson(){
      try{
        const resp = await fetch('channel.json');
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        // Поддерживаем оба формата: либо файл — массив сообщений, либо объект { messages: [...] }
        if (Array.isArray(data)) {
          posts = data;
        } else if (data && Array.isArray(data.messages)) {
          posts = data.messages;
        } else {
          posts = [];
          throw new Error('channel.json has no messages array');
        }
      }catch(e){
        document.getElementById('sentinel').textContent = 'Не удалось загрузить channel.json: ' + e.message;
        console.error(e);
      }
    }

    function loadNext(){
      if(index >= posts.length) {
        document.getElementById('sentinel').textContent = 'Все посты загружены';
        document.getElementById('status').textContent = 'Все посты загружены';
        console.log('loadNext: nothing to load, index', index, 'posts.length', posts.length);
        return;
      }
      const feed = document.getElementById('feed');
      const to = Math.min(index + BATCH, posts.length);
      try{console.log('loadNext start', {index, to, total: posts.length, ids: posts.slice(index,to).map(x=>x && x.id)})}catch(e){}
      for(let i = index; i < to; i++){
        const el = renderPost(posts[i]);
        feed.appendChild(el);
      }
      index = to;
      document.getElementById('count').textContent = index;
      if(index >= posts.length){
        document.getElementById('status').textContent = 'Все посты загружены';
      }
      try{console.log('loadNext done, new index', index)}catch(e){}
      if(index >= posts.length){
        document.getElementById('sentinel').textContent = 'Все посты загружены';
      }
    }

    // IntersectionObserver для подгрузки
    let loading = false;
    const observer = new IntersectionObserver((entries)=>{
      entries.forEach(ent=>{
        if(ent.isIntersecting){
          if(loading) return;
          if(index >= posts.length) {
            const s = document.getElementById('sentinel');
            observer.unobserve(s);
            s.textContent = 'Все посты загружены';
            return;
          }
          loading = true;
          try{
            loadNext();
          }catch(e){
            console.error(e);
          }
          loading = false;
        }
      });
    },{root:null,rootMargin:'0px',threshold:0.1});

    (async function(){
      await loadJson();
      // загрузим первую пачку
      loadNext();
      // наблюдаем sentinel
      const s = document.getElementById('sentinel');
      observer.observe(s);
    })();
  </script>
</body>
</html>